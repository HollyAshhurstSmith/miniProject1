<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Book</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.1/dist/echarts.min.js"></script>
    
    <style>
      .card-img-top {
        width: 100%;
        height: 400px;
        object-fit: contain;
      }

      .card-body {
        height: 250px;
        overflow-y: auto;
      }

      .card {
        margin-bottom: 20px;
      }

      .btn-container {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 10px;
      }

      h1 {
        font-family: Verdana;
        font-weight: bold;
        font-size: 70px;
        margin-top: 120px;
        margin-left: 120px;
      }

      .hidden {
        display: none;
      }

      ul {
        list-style-type: disc;
        padding-left: 20px;
      }
    </style>
  </head>
  <body>

    <h1>RECIPES</h1>

    <div class="container my-5">
      <div class="row">
        <div class="col-md-4">
          <input type="text" id="searchInput" class="form-control" placeholder="Search for a recipe..." />
        </div>
        <div class="col-md-4">
          <select id="sortSelect" class="form-control" onchange="sortRecipes()">
            <option value="">Sort By</option>
            <option value="az">A-Z</option>
            <option value="za">Z-A</option>
            <option value="time-asc">Time Low-High</option>
            <option value="time-desc">Time High-Low</option>
          </select>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecipeModal" onclick="clearModal()">Add Recipe</button>
          <button class="btn btn-secondary ms-2" onclick="getAllRecipes()">Get All Recipes</button>
          <button class="btn btn-warning ms-2" onclick="toggleRecipes()">Hide Recipes</button>
        </div>
      </div>
    </div>

    <!-- Modal for Adding/Editing Recipe -->
    <div class="modal fade" id="addRecipeModal" tabindex="-1" aria-labelledby="addRecipeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addRecipeModalLabel">Add/Edit Recipe</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Recipe Name -->
            <input type="text" id="recipeName" class="form-control mb-3" placeholder="Recipe Name" />
            
            <!-- Ingredients Input (now before Instructions) -->
            <textarea id="recipeIngredients" class="form-control mb-3" placeholder="Ingredients (separate with commas)" rows="4"></textarea>

            <!-- Instructions Input -->
            <textarea id="recipeInstructions" class="form-control mb-3" placeholder="Instructions (separate with commas)" rows="4"></textarea>

            <!-- Preparation Time -->
            <input type="number" id="prepTimeMinutes" class="form-control mb-3" placeholder="Preparation Time (Minutes)" />
            
            <!-- Image URL -->
            <input type="text" id="recipeImage" class="form-control mb-3" placeholder="Recipe Image URL" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveRecipe()">Save Recipe</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container my-5" id="card-container">
      <div class="row" id="recipe-row"></div>
    </div>

    <!-- Bootstrap JS and Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript">
      let allRecipes = [];
      let currentEditId = null;

      function displayRecipes(recipes) {
        const recipeRow = document.getElementById('recipe-row');
        recipeRow.innerHTML = '';  

        recipes.forEach(recipe => {
          const card = document.createElement('div');
          card.classList.add('col-md-3');

          card.innerHTML = `
            <div class="card mb-4" style="width: 18rem;">
              <img src="${recipe.image}" class="card-img-top" alt="${recipe.name}">
              <div class="card-body">
                <h5 class="card-title">${recipe.name}</h5>
                <p><strong>Ingredients:</strong></p>
                <ul>
                  ${recipe.ingredients.map(ingredient => `<li>${ingredient}</li>`).join('')}
                </ul>
                <h6><strong>Instructions:</strong></h6>
                <ul>
                  ${recipe.instructions.map((step, index) => `<li>Step ${index + 1}: ${step}</li>`).join('')}
                </ul>
                <p><strong>Time to prepare:</strong> ${recipe.prepTimeMinutes || 'Not Available'} minutes</p>
                <div class="btn-container d-flex justify-content-between">
                  <button class="btn btn-warning" onclick="editRecipe(${recipe.id})">Edit</button>
                  <button class="btn btn-danger" onclick="deleteRecipe(${recipe.id})">Delete</button>
                </div>
              </div>
            </div>
          `;

          recipeRow.appendChild(card);
        });
      }

      // Fetch all recipes when the page loads or when the button is pressed
      function getAllRecipes() {
        fetch('https://dummyjson.com/recipes')
          .then(res => res.json()) // Parse the JSON response
          .then(data => {
            console.log('Fetched Recipes:', data); // Log the entire response to the console
            allRecipes = data.recipes; // Store the fetched recipes
            displayRecipes(data.recipes); // Display the recipes
            const recipeRow = document.getElementById('recipe-row');
            recipeRow.classList.remove('hidden');
          })
          .catch((error) => {
            console.error('Error fetching data:', error);
          });
      }

      function addRecipe() {
        const name = document.getElementById('recipeName').value;
        const instructions = document.getElementById('recipeInstructions').value.split(',');
        const prepTimeMinutes = document.getElementById('prepTimeMinutes').value;
        const image = document.getElementById('recipeImage').value;
        const ingredients = document.getElementById('recipeIngredients').value.split(',');

        fetch('https://dummyjson.com/recipes/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            instructions: instructions,
            prepTimeMinutes: prepTimeMinutes,
            image: image,
            ingredients: ingredients
          })
        })
        .then(res => res.json())
        .then(console.log);

        const modal = bootstrap.Modal.getInstance(document.getElementById('addRecipeModal'));
        modal.hide();
      }

      function saveRecipe() {
        console.log('Save Recipe button clicked');
        
        if (currentEditId) {
          // Update the existing recipe
          const name = document.getElementById('recipeName').value;
          const instructions = document.getElementById('recipeInstructions').value.split(',');
          const prepTimeMinutes = document.getElementById('prepTimeMinutes').value;
          const image = document.getElementById('recipeImage').value;
          const ingredients = document.getElementById('recipeIngredients').value.split(',');

          // Log currentEditId to ensure it's set correctly
          console.log('Saving recipe with ID:', currentEditId);

          // Send PUT request to update the recipe with the new data
          fetch(`https://dummyjson.com/recipes/${currentEditId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              instructions: instructions,
              prepTimeMinutes: prepTimeMinutes,
              image: image,
              ingredients: ingredients
            })
          })
          .then(res => {
            if (!res.ok) {
              throw new Error(`Error: ${res.status}`);
            }
            return res.json();
          })
          .then(updatedRecipe => {
            console.log('Updated Recipe:', updatedRecipe); // Log updated recipe response
            // Update the local recipe list and re-render
            const recipeIndex = allRecipes.findIndex(recipe => recipe.id === currentEditId);
            if (recipeIndex !== -1) {
              allRecipes[recipeIndex] = {
                id: currentEditId,
                name,
                instructions,
                prepTimeMinutes,
                image,
                ingredients
              };
              displayRecipes(allRecipes);
            }
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addRecipeModal'));
            modal.hide();
          })
          .catch(error => {
            console.error('Error updating recipe:', error);
          });
        } else {
          // Handle adding a new recipe if currentEditId is not set
          addRecipe();
        }
        currentEditId = null; // Reset currentEditId after saving
      }

      function editRecipe(id) {
        // Find the recipe to edit
        const recipe = allRecipes.find(recipe => recipe.id === id);
        if (recipe) {
          document.getElementById('recipeName').value = recipe.name;
          document.getElementById('recipeIngredients').value = recipe.ingredients.join(',');
          document.getElementById('recipeInstructions').value = recipe.instructions.join(',');
          document.getElementById('prepTimeMinutes').value = recipe.prepTimeMinutes;
          document.getElementById('recipeImage').value = recipe.image;
          currentEditId = id;

          const modal = new bootstrap.Modal(document.getElementById('addRecipeModal'));
          modal.show();
        }
      }

      function deleteRecipe(id) {
        const recipeIndex = allRecipes.findIndex(recipe => recipe.id === id);
        if (recipeIndex !== -1) {
          allRecipes.splice(recipeIndex, 1);
          displayRecipes(allRecipes);
        }
      }

      function sortRecipes() {
        const sortBy = document.getElementById('sortSelect').value;

        if (sortBy === 'az') {
          allRecipes.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortBy === 'za') {
          allRecipes.sort((a, b) => b.name.localeCompare(a.name));
        } else if (sortBy === 'time-asc') {
          allRecipes.sort((a, b) => a.prepTimeMinutes - b.prepTimeMinutes);
        } else if (sortBy === 'time-desc') {
          allRecipes.sort((a, b) => b.prepTimeMinutes - a.prepTimeMinutes);
        }
        displayRecipes(allRecipes);
      }

      function toggleRecipes() {
        const recipeRow = document.getElementById('recipe-row');
        recipeRow.classList.toggle('hidden');
      }

      function clearModal() {
        currentEditId = null;
        document.getElementById('recipeName').value = '';
        document.getElementById('recipeIngredients').value = '';
        document.getElementById('recipeInstructions').value = '';
        document.getElementById('prepTimeMinutes').value = '';
        document.getElementById('recipeImage').value = '';
      }
    </script>

  </body>
</html>
